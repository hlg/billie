<?xml version="1.0" encoding="UTF-8"?>
<project name="vismapping" default="build" xmlns:ivy="antlib:org.apache.ivy.ant">

    <echo message="lets go"/>

    <ivy:settings file="D:/Nutzer/helga/ivysettings.xml"/>

    <property file="build.properties" />
    <property name="skip.tests" value="true"/>

    <!-- Compiler options -->
    <patternset id="ignored.files">
        <!-- add as needed -->
    </patternset>

    <patternset id="library.patterns">
        <include name="*.jar"/>
    </patternset>

    <patternset id="compiler.resources">
        <!-- add as needed -->
    </patternset>

    <dirname property="basedir" file="${ant.file}"/>

    <target name="config.module">
        <property name="module.basedir" value="${basedir}/${module.name}"/>
        <property name="module.output.dir" value="${module.basedir}/output/production"/>
        <path id="sourcepath">
            <dirset dir="${module.basedir}">
                <include name="src"/>
                <include name="test"/>
            </dirset>
        </path>
    </target>

    <target name="resolve.module" depends="config.module">
        <echo message="resolving: ${module.basedir}"/>
        <ivy:resolve file="${module.basedir}/ivy.xml"/>
        <ivy:cachepath pathid="ivy.classpath"/>
        <ivy:retrieve type="jar,bundle" />
        <!-- ivy:report / -->
    </target>

    <target name="compile.module" depends="resolve.module">
        <mkdir dir="${module.output.dir}/classes"/>
        <javac destdir="${module.output.dir}/classes" debug="on" srcdir="${module.basedir}/src">
            <classpath>
                <path refid="ivy.classpath"/>
            </classpath>
            <patternset refid="ignored.files"/>
        </javac>

        <copy todir="${module.output.dir}/classes">
            <fileset dir="${module.basedir}/src">
                <patternset refid="compiler.resources"/>
                <type type="file"/>
            </fileset>
            <fileset dir="${module.basedir}/test">
                <patternset refid="compiler.resources"/>
                <type type="file"/>
            </fileset>
        </copy>
    </target>


    <target name="dist.module" depends="compile.module">
        <tstamp/>
        <property name="specversion" value="0.1"/>  <!-- todo: per module specversion? -->
        <property name="implversion" value="${DSTAMP}${TSTAMP}"/>

        <pathconvert property="mf.classpath" pathsep=" ">
            <path refid="ivy.classpath"/>
            <flattenmapper/>
        </pathconvert>

        <mkdir dir="${module.output.dir}/jar"/>
        <jar jarfile="${module.output.dir}/jar/${module.name}-${specversion}-SNAPSHOT.jar" basedir="${module.output.dir}/classes">
            <manifest>
                <attribute name="Specification-Title" value="Visualization Mapping Framework"/>
                <attribute name="Specification-Version" value="${specversion}"/>
                <attribute name="Specification-Vendor" value="TU Dresden, CIB"/>
                <attribute name="Implementation-Title" value="snapshot"/>
                <attribute name="Implementation-Version" value="${implversion}"/>
                <attribute name="Implementation-Vendor" value="TU Dresden, CIB"/>
                <attribute name="Main-Class" value="configurations.Ifc3DMapper"/>
                <attribute name="Class-Path" value="${mf.classpath}"/>
            </manifest>
        </jar>

    </target>

    <target name="publish.module" depends="compile.module">
        <ivy:publish artifactspattern="${module.output.dir}/jar/[artifact]-[version]-SNAPSHOT.[ext]" resolver="local"
                     pubrevision="${specversion}" pubdate="${now}" status="integration" forcedeliver="true"/>
    </target>

    <target name="publish.all">
        <antcall target="publish.module"><param name="module.name" value="visMapping"/></antcall>
        <antcall target="publish.module"><param name="module.name" value="visMapping.configurations"/></antcall>
        <antcall target="publish.module"><param name="module.name" value="data.bimserver"/></antcall>
        <antcall target="publish.module"><param name="module.name" value="data.multimodel"/></antcall>
        <antcall target="publish.module"><param name="module.name" value="visualization.draw2d"/></antcall>
        <antcall target="publish.module"><param name="module.name" value="visualization.java3d"/></antcall>
    </target>

    <target name="clean.module" description="cleanup module">
        <delete dir="${module.output.dir}"/>
        <delete dir="${module.testoutput.dir}"/>
    </target>

    <target name="clean.all">
        <antcall target="clean.module"><param name="module.name" value="visMapping"/></antcall>
        <antcall target="clean.module"><param name="module.name" value="visMapping.configurations"/></antcall>
        <antcall target="clean.module"><param name="module.name" value="data.bimserver"/></antcall>
        <antcall target="clean.module"><param name="module.name" value="data.multimodel"/></antcall>
        <antcall target="clean.module"><param name="module.name" value="visualization.draw2d"/></antcall>
        <antcall target="clean.module"><param name="module.name" value="visualization.java3d"/></antcall>
    </target>

    <target name="build" depends="clean.all" description="clean build and package"/>
</project>
