<?xml version="1.0" encoding="UTF-8"?>
<project name="vismapping" default="build" xmlns:ivy="antlib:org.apache.ivy.ant">


    <property file="build.properties"/>
    <property name="skip.tests" value="true"/>

    <!-- Compiler options -->
    <patternset id="ignored.files">
        <!-- add as needed -->
    </patternset>

    <patternset id="library.patterns">
        <include name="*.jar"/>
    </patternset>

    <patternset id="compiler.resources">
        <!-- todo: clean up -->
        <include name="**/?*.properties"/>
        <include name="**/?*.xml"/>
        <include name="**/?*.gif"/>
        <include name="**/?*.png"/>
        <include name="**/?*.jpeg"/>
        <include name="**/?*.jpg"/>
        <include name="**/?*.html"/>
        <include name="**/?*.dtd"/>
        <include name="**/?*.tld"/>
        <include name="**/?*.ftl"/>
        <include name="**/?*.X81"/>
        <include name="**/?*.ifc"/>
        <include name="**/?*.zip"/>
    </patternset>

    <path id="library.mfcontainerparser.classpath">
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/de.mefisto.container_1.0.0.201201272248/container.jar"/>
    </path>


    <dirname property="basedir" file="${ant.file}"/>
    <property name="module.vismapping.basedir" value="${basedir}/visMapping"/>

    <property name="output.dir" value="${module.vismapping.basedir}/out/production/visMapping"/>
    <property name="testoutput.dir" value="${module.vismapping.basedir}/out/test/visMapping"/>


    <path id="classpath">
        <path refid="library.mfcontainerparser.classpath"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/org.eclipse.emf.ecore_2.7.0.v20110605-0747.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/org.eclipse.emf.ecore.xmi_2.7.0.v20110520-1406.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/org.eclipse.draw2d_3.7.0.v20110425-2050.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/org.eclipse.emf.common_2.7.0.v20110605-0747.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/org.eclipse.swt.win32.win32.x86_3.7.0.v3735b.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/cib.lib.gaeb.model_1.0.0.201201272248/gaeb.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/cib.mmaa.qto.elementaryModel_1.0.0.201201272248.jar"/>
        <pathelement
                location="${path.variable.javalibs}/mmaa_oldnstable/plugins/cib.mf.schedule.model_1.0.0.201201272248/schedule.jar"/>
    </path>

    <path id="sourcepath">
        <dirset dir="${module.vismapping.basedir}">
            <include name="src"/>
            <include name="test"/>
        </dirset>
    </path>


    <target name="resolve">
        <property name="ivy.lib.dir" value="${output.dir}/lib" />
        <ivy:resolve file="visMapping/ivy.xml"/>
        <ivy:cachepath pathid="ivy.classpath"/>
        <ivy:retrieve type="jar,bundle" />
        <!-- ivy:report / -->
    </target>

    <target name="compile" depends="compile.production, compile.tests"/>

    <target name="compile.production" depends="resolve">
        <mkdir dir="${output.dir}/classes"/>
        <javac destdir="${output.dir}/classes" debug="on" srcdir="${module.vismapping.basedir}/src">
            <classpath>
                <path refid="classpath"/>
                <path refid="ivy.classpath"/>
            </classpath>
            <patternset refid="ignored.files"/>
        </javac>

        <copy todir="${output.dir}/classes">
            <fileset dir="${module.vismapping.basedir}/src">
                <patternset refid="compiler.resources"/>
                <type type="file"/>
            </fileset>
            <fileset dir="${module.vismapping.basedir}/test">
                <patternset refid="compiler.resources"/>
                <type type="file"/>
            </fileset>
        </copy>
    </target>

    <target name="compile.tests" depends="compile.production" unless="skip.tests">
    </target>

    <target name="dist" depends="compile">
        <tstamp/>
        <property name="specversion" value="0.1"/>
        <property name="implversion" value="${DSTAMP}${TSTAMP}"/>

        <pathconvert property="mf.classpath" pathsep=" ">
            <path refid="ivy.classpath"/>
            <flattenmapper/>
        </pathconvert>

        <mkdir dir="${output.dir}/jar"/>
        <jar jarfile="${output.dir}/jar/visMapping-${specversion}-${implversion}.jar" basedir="${output.dir}/classes">
            <manifest>
                <attribute name="Specification-Title" value="Visualization Mapping Framework"/>
                <attribute name="Specification-Version" value="${specversion}"/>
                <attribute name="Specification-Vendor" value="TU Dresden, CIB"/>
                <attribute name="Implementation-Title" value="snapshot"/>
                <attribute name="Implementation-Version" value="${implversion}"/>
                <attribute name="Implementation-Vendor" value="TU Dresden, CIB"/>
                <attribute name="Main-Class" value="configurations.Ifc3DMapper"/>
                <attribute name="Class-Path" value="${mf.classpath}"/>
            </manifest>
        </jar>

    </target>

    <target name="clean" description="cleanup module">
        <delete dir="${output.dir}"/>
        <delete dir="${testoutput.dir}"/>
    </target>

    <target name="build" depends="clean, compile, dist" description="clean build and package"/>

</project>
